<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LLM Benchmarks</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Newsreader:ital,opsz,wght@0,6..72,400;0,6..72,600;1,6..72,400&family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f5f4f1;
      --surface: #ffffff;
      --surface-alt: #f2f1ee;
      --text: #111111;
      --muted: #6b6b6b;
      --subtle: #ababab;
      --line: #e2e1de;
      --line-soft: #edece9;
      --accent: #1d4ed8;
      --accent-hover: #1e40af;
      --gold-bg: #fef9c3;
      --gold-text: #713f12;
      --gold-border: rgba(202, 138, 4, 0.35);
      --font-display: "Newsreader", Georgia, serif;
      --font-ui: "DM Sans", "Segoe UI", sans-serif;
      --font-mono: "JetBrains Mono", "Consolas", monospace;
      --radius: 10px;
      --shadow: 0 1px 4px rgba(0, 0, 0, 0.06), 0 6px 24px rgba(0, 0, 0, 0.06);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      overflow-y: scroll;
    }

    html,
    body {
      min-height: 100%;
      background: var(--bg);
      background-image: radial-gradient(circle, #ccc9c2 1px, transparent 1px);
      background-size: 22px 22px;
      color: var(--text);
      font-family: var(--font-ui);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .page {
      width: min(2400px, 96vw);
      margin: 32px auto;
      background: var(--surface);
      border: 1px solid var(--line);
      border-left: 3px solid var(--accent);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    /* ── Hero ─────────────────────────────────────── */

    .hero {
      padding: 32px 40px 26px;
      border-bottom: 1px solid var(--line);
      animation: fadeIn 350ms ease;
    }

    .hero h1 {
      font-family: var(--font-display);
      font-size: clamp(1.8rem, 3vw, 2.6rem);
      font-weight: 600;
      letter-spacing: -0.025em;
      line-height: 1.1;
      color: var(--text);
    }

    .hero p {
      margin-top: 8px;
      color: var(--muted);
      max-width: 800px;
      line-height: 1.5;
      font-size: 0.9rem;
      font-weight: 600;
      letter-spacing: 0.01em;
    }

    /* ── Controls ─────────────────────────────────── */

    .controls {
      padding: 20px 40px;
      background: var(--surface);
      border-bottom: 1px solid var(--line);
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      align-items: start;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 5px;
      min-width: 0;
    }

    .field label {
      color: var(--subtle);
      font-size: 0.7rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-family: var(--font-mono);
    }

    input[type="text"],
    select {
      width: 100%;
      height: 42px;
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 0 12px;
      font-size: 0.87rem;
      background: var(--surface);
      color: var(--text);
      font-family: var(--font-ui);
      font-weight: 600;
      transition: border-color 150ms ease, box-shadow 150ms ease;
      -webkit-appearance: none;
      appearance: none;
      outline: none;
    }

    select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23ababab' stroke-width='1.5' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 32px;
    }

    select[multiple] {
      background-image: none;
      padding: 4px 12px 8px;
      font-size: 0.80rem;
      font-weight: 700;
      transition: height 200ms ease;
      scrollbar-width: none;
    }

    select[multiple]::-webkit-scrollbar {
      display: none;
    }

    select[multiple] option {
      font-weight: 700;
    }

    .select-wrap {
      position: relative;
    }

    .clear-compare {
      position: absolute;
      top: 50%;
      right: 6px;
      transform: translateY(-50%);
      width: 20px;
      height: 20px;
      min-height: unset;
      padding: 0;
      border-radius: 4px;
      border: none;
      background: none;
      color: var(--muted);
      font-size: 0.9rem;
      line-height: 1;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: var(--font-ui);
      transition: color 120ms ease;
      z-index: 1;
    }

    .clear-compare:hover {
      color: var(--text);
    }


    input[type="text"]:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(29, 78, 216, 0.1);
    }

    button:focus-visible,
    th:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .check {
      flex-direction: row;
      align-items: center;
      gap: 8px;
      padding-bottom: 8px;
      font-size: 0.88rem;
      color: var(--muted);
      font-weight: 600;
    }

    /* ── Toolbar ──────────────────────────────────── */

    .toolbar {
      padding: 10px 40px 12px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      border-bottom: 1px solid var(--line);
      background: var(--surface-alt);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 6px;
      background: var(--surface);
      color: var(--muted);
      border: 1px solid var(--line);
      font-size: 0.72rem;
      font-weight: 700;
      font-family: var(--font-mono);
      letter-spacing: 0.03em;
    }

    button {
      border: 1px solid var(--line);
      background: var(--surface);
      border-radius: 8px;
      color: var(--muted);
      min-height: 32px;
      padding: 0 12px;
      font-size: 0.78rem;
      font-weight: 700;
      cursor: pointer;
      font-family: var(--font-ui);
      letter-spacing: 0.03em;
      transition: background-color 120ms ease, color 120ms ease, border-color 120ms ease;
    }

    button:hover {
      background: var(--surface-alt);
      color: var(--text);
      border-color: #c4c3c0;
    }

    .file-input-offscreen {
      position: fixed;
      left: -9999px;
      top: -9999px;
      width: 1px;
      height: 1px;
      opacity: 0;
      pointer-events: none;
    }

    /* ── Table ────────────────────────────────────── */

    .table-shell {
      overflow: auto;
      max-height: calc(100vh - 260px);
      min-height: 300px;
    }

    table {
      width: max(1160px, 100%);
      border-collapse: separate;
      border-spacing: 0;
      font-size: 0.82rem;
    }

    thead th {
      position: sticky;
      top: 0;
      z-index: 2;
      background: var(--surface-alt);
      border-bottom: 1px solid var(--line);
      padding: 10px 10px;
      text-align: left;
      color: var(--muted);
      white-space: nowrap;
      cursor: pointer;
      user-select: none;
      transition: color 120ms ease, background-color 120ms ease;
      font-family: var(--font-mono);
      font-size: 0.65rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      overflow: visible;
    }

    thead th:hover {
      background: #eae9e6;
      color: var(--text);
    }

    /* Sorted column: subtle tint */
    thead th:has(.sort-indicator) {
      background: #eef1fb !important;
      color: var(--text) !important;
      border-bottom-color: #c7d2f5 !important;
      text-align: left;
    }

    thead th:has(.sort-indicator):hover {
      background: #e4e9f8 !important;
    }

    /* Sticky first column */
    th:first-child,
    td:first-child {
      position: sticky;
      left: 0;
      z-index: 1;
      background: var(--surface);
    }

    thead th:first-child {
      z-index: 3;
      background: var(--surface-alt);
    }

    thead th:first-child:has(.sort-indicator) {
      background: #eef1fb !important;
    }

    tbody td {
      border-bottom: 1px solid var(--line-soft);
      padding: 9px 10px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    tbody tr:nth-child(even) td {
      background: #fafaf8;
    }

    tbody tr:hover td {
      background: #eeeeed;
    }

    /* Keep top-score visible on hover */
    tbody tr:hover td.top-score {
      background: #fef08a !important;
    }

    .col-model {
      min-width: 220px;
      max-width: 340px;
      font-family: var(--font-mono);
      font-weight: 700;
      color: var(--text);
    }

    td.col-model {
      font-size: 0.82rem;
    }

    .col-model a {
      color: var(--text);
      font-weight: 700;
      text-decoration: none;
    }

    .col-model a:hover {
      color: var(--accent);
      text-decoration: underline;
    }

    .creator {
      font-family: var(--font-mono);
      font-size: 0.82rem;
      font-weight: 500;
      color: var(--muted);
    }

    .creator a {
      color: var(--muted);
      text-decoration: none;
      font-weight: 500;
    }

    .creator a:hover {
      color: var(--text);
    }

    .mono,
    .num {
      font-family: var(--font-mono);
    }

    .num {
      text-align: right;
      font-weight: 700;
      color: var(--text);
    }

    td.num {
      font-size: 0.82rem;
      padding-right: 14px;
    }

    .num.na {
      color: var(--subtle);
      font-style: normal;
      font-weight: 400;
    }

    /* Top score: vivid amber, high contrast */
    .top-score {
      background: var(--gold-bg) !important;
      color: var(--gold-text) !important;
      box-shadow: inset 0 0 0 1px var(--gold-border);
      border-radius: 4px;
    }

    .top-score.num {
      font-weight: 800;
    }

    .top-row td {
      box-shadow: inset 0 -1px 0 rgba(202, 138, 4, 0.2), inset 0 1px 0 rgba(202, 138, 4, 0.1);
    }

    .sort-indicator {
      position: absolute;
      right: 8px;
      top: 45%;
      transform: translateY(-50%);
      color: var(--accent);
      font-weight: 800;
      font-size: 0.72rem;
    }

    .bench-head {
      max-width: 120px;
    }

    .bench-head .th-label {
      display: inline-block;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 100%;
      vertical-align: middle;
    }

    thead th:has(.sort-indicator) .th-label {
      display: inline-block;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: calc(100% - 8px);
      vertical-align: middle;
    }


    .empty {
      margin: 24px;
      padding: 40px;
      text-align: center;
      color: var(--muted);
      border: 1px dashed var(--line);
      border-radius: 10px;
      background: var(--surface);
      font-weight: 600;
      font-size: 0.9rem;
    }

    .status {
      padding: 40px;
      color: var(--muted);
      font-weight: 600;
    }

    .status.error {
      color: #991b1b;
    }

    /* ── Benchmarks panel ─────────────────────────── */

    .benchmarks-panel {
      margin: 0;
      padding: 28px 40px 36px;
      border-top: 1px solid var(--line);
      background: var(--surface-alt);
    }

    .benchmarks-panel h2 {
      margin: 0 0 14px;
      color: var(--subtle);
      font-size: 0.68rem;
      font-weight: 700;
      letter-spacing: 0.13em;
      text-transform: uppercase;
      font-family: var(--font-mono);
    }

    .benchmarks-list {
      display: grid;
      gap: 8px;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    }

    .benchmark-item {
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 12px 14px;
      background: var(--surface);
      transition: border-color 150ms ease;
      display: flex;
      flex-direction: column;
    }

    .benchmark-item:hover {
      border-color: #bbb;
    }

    .benchmark-head {
      display: flex;
      gap: 8px;
      align-items: baseline;
      flex-wrap: wrap;
      margin-bottom: 4px;
    }

    .benchmark-name {
      font-weight: 700;
      color: var(--text);
      font-size: 0.88rem;
    }

    .benchmark-category {
      color: var(--subtle);
      font-size: 0.68rem;
      font-weight: 700;
      font-family: var(--font-mono);
      text-transform: uppercase;
      letter-spacing: 0.07em;
    }

    .benchmark-desc {
      margin: 0;
      color: var(--muted);
      line-height: 1.5;
      font-size: 0.82rem;
      font-weight: 500;
    }

    .benchmark-links {
      margin-top: auto;
      padding-top: 8px;
      display: block;
    }

    .benchmark-links a {
      display: block;
      color: var(--accent);
      text-decoration: none;
      font-size: 0.76rem;
      font-weight: 600;
      font-family: var(--font-mono);
      margin-top: 2px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .benchmark-links a:hover {
      text-decoration: underline;
    }

    /* ── Animations ───────────────────────────────── */

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(5px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ── Column resize handles ────────────────────── */

    thead th {
      overflow: visible;
    }

    .col-resize-handle {
      position: absolute;
      top: 0;
      right: 0;
      width: 6px;
      height: 100%;
      cursor: col-resize;
      z-index: 4;
      background: transparent;
      transition: background-color 100ms ease;
    }

    thead th:has(.sort-indicator) .col-resize-handle:hover,
    thead th:has(.sort-indicator) .col-resize-handle:active {
      background: rgba(0, 0, 0, 0.1);
    }

    thead th:not(:has(.sort-indicator)) .col-resize-handle:hover,
    thead th:not(:has(.sort-indicator)) .col-resize-handle:active {
      background: rgba(0, 0, 0, 0.1);
    }

    body.col-resizing {
      cursor: col-resize !important;
      user-select: none !important;
    }

    body.col-resizing * {
      cursor: col-resize !important;
    }

    /* ── Responsive ───────────────────────────────── */

    @media (max-width: 860px) {
      .page {
        width: 100vw;
        margin: 0;
        border-radius: 0;
        border-left-width: 3px;
        min-height: 100vh;
      }

      .hero,
      .controls,
      .toolbar {
        padding-left: 16px;
        padding-right: 16px;
      }

      .benchmarks-panel {
        padding-left: 16px;
        padding-right: 16px;
        padding-bottom: 24px;
      }

      .table-shell {
        max-height: none;
        min-height: 220px;
      }

      table {
        width: max(1020px, 100%);
      }
    }
  </style>
</head>
<body>
  <main class="page" id="app" aria-live="polite">
    <section class="hero">
      <h1 id="title">LLM Benchmarks</h1>
      <p>Compare performance of small(ish) LLM models across benchmark suites.</p>
    </section>

    <section class="controls" id="controls" hidden>
      <div class="field">
        <label for="modelCompare">Compare Models</label>
        <div class="select-wrap">
          <select id="modelCompare" multiple></select>
          <button id="clearCompare" class="clear-compare" type="button" hidden title="Unselect all">×</button>
        </div>
      </div>
      <div class="field">
        <label for="search">Search</label>
        <input id="search" type="text" placeholder="Model or creator">
      </div>
      <div class="field">
        <label for="params">Params</label>
        <select id="params"></select>
      </div>
      <div class="field">
        <label for="sortMode">Sort</label>
        <select id="sortMode"></select>
      </div>
    </section>

    <section class="toolbar" id="toolbar" hidden>
      <span class="pill" id="resultCount">0 models</span>
      <span class="pill" id="benchmarkCount">0 benchmarks</span>
      <button id="resetBtn" type="button">Reset Filters</button>
      <button style="display: none" id="importBtn" type="button">Import llm.json</button>
      <input id="importFile" class="file-input-offscreen" type="file" accept="application/json,.json">
    </section>

    <section id="content">
      <div class="status" id="status">Loading benchmark data...</div>
    </section>
  </main>

  <script>
    (function () {
      const PRIORITY_BENCHMARK_KEYS = ["aa_intelligence_index", "aa_coding_index"];
      const BENCHMARK_LABEL_OVERRIDES = {
        aa_intelligence_index: "General Index",
        aa_coding_index: "Coding Index"
      };

      const state = {
        data: null,
        benchmarkKeys: [],
        filteredModels: [],
        filters: {
          search: "",
          params: "all",
          selectedModels: []
        },
        sort: {
          key: "aa_intelligence_index",
          direction: "desc"
        },
        eventsBound: false,
        columnWidths: {}
      };

      const ui = {
        title: document.getElementById("title"),
        controls: document.getElementById("controls"),
        toolbar: document.getElementById("toolbar"),
        content: document.getElementById("content"),
        status: document.getElementById("status"),
        search: document.getElementById("search"),
        params: document.getElementById("params"),
        modelCompare: document.getElementById("modelCompare"),
        sortMode: document.getElementById("sortMode"),
        resultCount: document.getElementById("resultCount"),
        benchmarkCount: document.getElementById("benchmarkCount"),
        importBtn: document.getElementById("importBtn"),
        importFile: document.getElementById("importFile"),
        resetBtn: document.getElementById("resetBtn"),
        clearCompare: document.getElementById("clearCompare")
      };

      bindImportEvents();
      loadData();

      async function loadData() {
        try {
          const cacheBustedUrl = `https://raw.githubusercontent.com/dgrieser/ai-bench/refs/heads/main/llm.json?t=${Date.now()}`;
          const response = await fetch(cacheBustedUrl, { cache: "no-store" });
          if (!response.ok) {
            throw new Error(`Request failed (${response.status})`);
          }
          const data = await response.json();
          validateData(data);
          init(data);
        } catch (err) {
          showImportOnly(`Unable to load llm.json automatically. ${err.message}`);
        }
      }

      function showImportOnly(message) {
        ui.toolbar.hidden = false;
        ui.controls.hidden = true;
        ui.status.classList.add("error");
        ui.status.textContent = message;
        ui.resultCount.textContent = "No data loaded";
        ui.benchmarkCount.textContent = "Import required";
      }

      function validateData(data) {
        if (!data || typeof data !== "object") {
          throw new Error("Invalid JSON root.");
        }
        if (!Array.isArray(data.models) || !data.benchmarks || typeof data.benchmarks !== "object") {
          throw new Error("Expected models[] and benchmarks{}.");
        }
      }

      function init(data) {
        state.data = data;
        state.benchmarkKeys = getOrderedBenchmarkKeys(data.benchmarks);

        ui.title.textContent = data.title || "LLM Benchmarks";
        ui.controls.hidden = false;
        ui.toolbar.hidden = false;
        ui.status.classList.remove("error");

        populateFilters();
        if (!state.eventsBound) {
          bindEvents();
          state.eventsBound = true;
        }
        applyAndRender();
      }

      function bindImportEvents() {
        ui.modelCompare.addEventListener("focus", function () {
          if (!this.options.length) return;
          this.style.height = (this.scrollHeight + 3) + "px";
        });

        ui.modelCompare.addEventListener("blur", function () {
          this.style.height = "42px";
        });

        ui.importBtn.addEventListener("click", () => {
          ui.importFile.click();
        });

        ui.importFile.addEventListener("change", async (event) => {
          const file = event.target.files && event.target.files[0];
          if (!file) {
            return;
          }

          try {
            const text = await file.text();
            const imported = JSON.parse(text);
            validateData(imported);
            state.filters.search = "";
            state.filters.params = "all";
            state.filters.selectedModels = [];
            state.sort.key = "aa_intelligence_index";
            state.sort.direction = "desc";
            ui.search.value = "";
            ui.params.value = "all";
            ui.modelCompare.selectedIndex = -1;
            ui.sortMode.value = sortModeValue(state.sort.key, state.sort.direction);
            init(imported);
          } catch (err) {
            ui.content.innerHTML = `<div class="status error">Import failed: ${escapeHtml(err.message || "Invalid JSON file.")}</div>`;
          } finally {
            ui.importFile.value = "";
          }
        });
      }

      function populateFilters() {
        const modelNames = [...new Set(state.data.models.map((m) => m.name || "Unknown"))].sort((a, b) => a.localeCompare(b));
        ui.modelCompare.innerHTML = modelNames
          .map((name) => `<option value="${escapeHtml(name)}">${escapeHtml(name)}</option>`)
          .join("");

        const paramOptions = [
          { value: "all", label: "All parameter sizes" },
          { value: "lt30", label: "< 30B" },
          { value: "30to80", label: "30B to 80B" },
          { value: "80to130", label: "80B to 130B" },
          { value: "130to250", label: "130B to 250B" },
          { value: "gte250", label: ">= 250B" }
        ];

        ui.params.innerHTML = paramOptions
          .map((option) => `<option value="${escapeHtml(option.value)}">${escapeHtml(option.label)}</option>`)
          .join("");
        ui.params.value = state.filters.params;

        const fixedSortOptions = [
          { key: "name", label: "Model name" },
          { key: "creator", label: "Creator" },
          { key: "params", label: "Params" },
          { key: "context", label: "Context" }
        ];

        const benchmarkSortOptions = state.benchmarkKeys.map((key) => ({
          key,
          label: getBenchmarkLabel(key)
        }));

        const sortOptions = [...fixedSortOptions, ...benchmarkSortOptions];
        ui.sortMode.innerHTML = sortOptions.map((option) => {
          const ascLabel = `${option.label} ↑`;
          const descLabel = `${option.label} ↓`;
          return [
            `<option value="${escapeHtml(sortModeValue(option.key, "desc"))}">${escapeHtml(descLabel)}</option>`,
            `<option value="${escapeHtml(sortModeValue(option.key, "asc"))}">${escapeHtml(ascLabel)}</option>`
          ].join("");
        }).join("");

        ui.sortMode.value = sortModeValue(state.sort.key, state.sort.direction);
      }

      function bindEvents() {
        ui.search.addEventListener("input", debounce((event) => {
          state.filters.search = event.target.value.trim().toLowerCase();
          applyAndRender();
        }, 100));

        ui.params.addEventListener("change", (event) => {
          state.filters.params = event.target.value;
          applyAndRender();
        });

        ui.modelCompare.addEventListener("change", () => {
          state.filters.selectedModels = Array.from(ui.modelCompare.selectedOptions).map((option) => option.value);
          ui.clearCompare.hidden = state.filters.selectedModels.length === 0;
          applyAndRender();
        });

        ui.clearCompare.addEventListener("mousedown", (e) => {
          e.preventDefault(); // prevent select blur/change from firing before click
        });

        ui.clearCompare.addEventListener("click", () => {
          Array.from(ui.modelCompare.options).forEach((opt) => { opt.selected = false; });
          state.filters.selectedModels = [];
          ui.clearCompare.hidden = true;
          applyAndRender();
        });

        ui.sortMode.addEventListener("change", (event) => {
          const nextSort = parseSortModeValue(event.target.value);
          state.sort.key = nextSort.key;
          state.sort.direction = nextSort.direction;
          applyAndRender();
        });

        ui.resetBtn.addEventListener("click", () => {
          if (!state.data) {
            return;
          }

          state.filters.search = "";
          state.filters.params = "all";
          state.filters.selectedModels = [];
          state.sort.key = "aa_intelligence_index";
          state.sort.direction = "desc";

          ui.search.value = "";
          ui.params.value = "all";
          ui.modelCompare.selectedIndex = -1;
          ui.clearCompare.hidden = true;
          ui.sortMode.value = sortModeValue(state.sort.key, state.sort.direction);

          applyAndRender();
        });
      }

      function applyAndRender() {
        if (!state.data) {
          return;
        }

        const models = state.data.models
          .map((model) => {
            return {
              ...model,
              creatorName: model.creator?.name || "Unknown"
            };
          })
          .filter((model) => modelPassesFilters(model));

        sortModels(models);
        state.filteredModels = models;

        renderTable();
        updateMeta();
      }

      function modelPassesFilters(model) {
        if (state.filters.search) {
          const haystack = `${model.name || ""} ${model.creatorName}`.toLowerCase();
          if (!haystack.includes(state.filters.search)) {
            return false;
          }
        }

        const modelParams = parseUnitNumber(model.params);
        if (state.filters.params !== "all") {
          if (!Number.isFinite(modelParams)) {
            return false;
          }
          if (state.filters.params === "lt30" && !(modelParams < 30e9)) {
            return false;
          }
          if (state.filters.params === "30to80" && !(modelParams >= 30e9 && modelParams <= 80e9)) {
            return false;
          }
          if (state.filters.params === "80to130" && !(modelParams > 80e9 && modelParams <= 130e9)) {
            return false;
          }
          if (state.filters.params === "130to250" && !(modelParams > 130e9 && modelParams < 250e9)) {
            return false;
          }
          if (state.filters.params === "gte250" && !(modelParams >= 250e9)) {
            return false;
          }
        }

        if (state.filters.selectedModels.length && !state.filters.selectedModels.includes(model.name || "Unknown")) {
          return false;
        }

        return true;
      }

      function sortModels(models) {
        const directionFactor = state.sort.direction === "asc" ? 1 : -1;

        models.sort((a, b) => {
          const left = valueForSort(a, state.sort.key);
          const right = valueForSort(b, state.sort.key);

          const leftMissing = left == null || Number.isNaN(left);
          const rightMissing = right == null || Number.isNaN(right);

          if (leftMissing && rightMissing) {
            return String(a.name || "").localeCompare(String(b.name || ""));
          }
          if (leftMissing) {
            return 1;
          }
          if (rightMissing) {
            return -1;
          }

          if (typeof left === "number" && typeof right === "number") {
            return (left - right) * directionFactor;
          }

          return String(left).localeCompare(String(right)) * directionFactor;
        });
      }

      function valueForSort(model, key) {
        if (key === "name") {
          return model.name || "";
        }
        if (key === "creator") {
          return model.creatorName || "";
        }
        if (key === "params") {
          return parseUnitNumber(model.params);
        }
        if (key === "context") {
          return parseUnitNumber(model.context);
        }
        return toNumber(model.scores?.[key]);
      }

      function renderTable() {
        if (!state.filteredModels.length) {
          ui.content.innerHTML = `
            <div class="empty">No models match your filters.</div>
            ${renderBenchmarkDirectory()}
          `;
          return;
        }

        const headers = [
          { key: "name", label: "Model", className: "col-model" },
          { key: "creator", label: "Creator" },
          { key: "params", label: "Params", className: "mono" },
          { key: "context", label: "Context", className: "mono" },
          ...state.benchmarkKeys.map((key) => ({
            key,
            label: getBenchmarkLabel(key),
            title: state.data.benchmarks[key]?.description || "",
            className: "num bench-head"
          }))
        ];

        const bestInTableByModel = getBestInTableByModel(state.filteredModels);

        const tableHtml = `
          <div class="table-shell">
            <table aria-label="LLM benchmark table">
              <thead>
                <tr>
                  ${headers.map((header) => renderHeaderCell(header)).join("")}
                </tr>
              </thead>
              <tbody>
                ${state.filteredModels.map((model) => renderRow(model, bestInTableByModel.get(model) || new Set())).join("")}
              </tbody>
            </table>
          </div>
          ${renderBenchmarkDirectory()}
        `;

        ui.content.innerHTML = tableHtml;

        ui.content.querySelectorAll("th[data-sort-key]").forEach((th) => {
          th.addEventListener("click", () => {
            const key = th.dataset.sortKey;
            if (!key) {
              return;
            }
            if (state.sort.key === key) {
              state.sort.direction = state.sort.direction === "desc" ? "asc" : "desc";
            } else {
              state.sort.key = key;
              state.sort.direction = key === "name" || key === "creator" ? "asc" : "desc";
            }

            ui.sortMode.value = sortModeValue(state.sort.key, state.sort.direction);
            applyAndRender();
          });
        });

        initColumnResize();
      }

      function renderBenchmarkDirectory() {
        const items = state.benchmarkKeys.map((key) => {
          const benchmark = state.data?.benchmarks?.[key] || {};
          const name = getBenchmarkLabel(key);
          const category = benchmark.category || "";
          const description = benchmark.description || "";
          const links = benchmarkLinks(benchmark);

          return `
            <article class="benchmark-item">
              <div class="benchmark-head">
                <span class="benchmark-name">${escapeHtml(name)}</span>
                ${category ? `<span class="benchmark-category">${escapeHtml(category)}</span>` : ""}
              </div>
              ${description ? `<p class="benchmark-desc">${escapeHtml(description)}</p>` : ""}
              ${links.length ? `<div class="benchmark-links">${links.map((url) => `<a href="${escapeAttr(url)}" target="_blank" rel="noopener noreferrer">${escapeHtml(url)}</a>`).join("")}</div>` : ""}
            </article>
          `;
        }).join("");

        return `
          <section class="benchmarks-panel" aria-label="Benchmark details">
            <h2>Benchmarks</h2>
            <div class="benchmarks-list">${items}</div>
          </section>
        `;
      }

      function benchmarkLinks(benchmark) {
        if (!benchmark || typeof benchmark !== "object") {
          return [];
        }
        if (Array.isArray(benchmark.urls)) {
          return benchmark.urls.filter((url) => typeof url === "string" && url.trim().length > 0);
        }
        if (typeof benchmark.url === "string" && benchmark.url.trim().length > 0) {
          return [benchmark.url];
        }
        return [];
      }

      function initColumnResize() {
        const table = ui.content.querySelector("table");
        if (!table) return;
        const ths = table.querySelectorAll("thead th");

        // Capture natural widths for columns not yet stored
        ths.forEach((th) => {
          const key = th.dataset.sortKey;
          if (key && !state.columnWidths[key]) {
            state.columnWidths[key] = th.getBoundingClientRect().width;
          }
        });

        // Switch to fixed layout and apply stored widths
        table.style.tableLayout = "fixed";
        ths.forEach((th) => {
          const key = th.dataset.sortKey;
          if (key && state.columnWidths[key]) {
            th.style.width = state.columnWidths[key] + "px";
          }
        });

        // Attach mousedown listeners to resize handles
        table.querySelectorAll(".col-resize-handle").forEach((handle) => {
          handle.addEventListener("mousedown", onResizeMouseDown);
        });
      }

      function onResizeMouseDown(e) {
        e.preventDefault();
        e.stopPropagation();

        const handle = e.currentTarget;
        const th = handle.closest("th");
        const key = handle.dataset.resizeKey;
        if (!th || !key) return;

        const startX = e.clientX;
        const startWidth = th.getBoundingClientRect().width;

        document.body.classList.add("col-resizing");

        function onMouseMove(e) {
          const newWidth = Math.max(50, startWidth + (e.clientX - startX));
          th.style.width = newWidth + "px";
        }

        function onMouseUp(e) {
          document.removeEventListener("mousemove", onMouseMove);
          document.removeEventListener("mouseup", onMouseUp);
          document.body.classList.remove("col-resizing");

          const finalWidth = Math.max(50, startWidth + (e.clientX - startX));
          state.columnWidths[key] = finalWidth;
          th.style.width = finalWidth + "px";

          // Swallow the click event the browser fires after mouseup so sort doesn't trigger
          th.addEventListener("click", (ev) => ev.stopPropagation(), { capture: true, once: true });
        }

        document.addEventListener("mousemove", onMouseMove);
        document.addEventListener("mouseup", onMouseUp);
      }

      function renderHeaderCell(header) {
        const isSorted = state.sort.key === header.key;
        const sortSymbol = isSorted ? (state.sort.direction === "desc" ? "▼" : "▲") : "";
        const indicator = isSorted ? `<span class="sort-indicator">${sortSymbol}</span>` : "";

        const className = header.className ? ` ${header.className}` : "";
        const title = header.title ? ` title="${escapeHtml(header.title)}"` : "";

        const resizeHandle = `<div class="col-resize-handle" data-resize-key="${escapeHtml(header.key)}"></div>`;
        return `<th class="${className.trim()}" data-sort-key="${escapeHtml(header.key)}"${title}><span class="th-label">${escapeHtml(header.label)}</span>${indicator}${resizeHandle}</th>`;
      }

      function renderRow(model, bestInTable) {
        const modelName = escapeHtml(model.name || "Unknown");
        const modelUrl = model.url || "";
        const creatorName = escapeHtml(model.creatorName);
        const creatorUrl = model.creator?.url || "";
        const contextClass = bestInTable.has("context") ? " top-score" : "";

        const scoreCells = state.benchmarkKeys.map((key) => {
          const value = toNumber(model.scores?.[key]);
          const isTop = bestInTable.has(key);
          const className = isTop ? "num top-score" : "num";

          return `<td class="${className}">${formatScore(value)}</td>`;
        }).join("");

        return `
          <tr>
            <td class="col-model">${modelUrl ? `<a href="${escapeAttr(modelUrl)}" target="_blank" rel="noopener noreferrer">${modelName}</a>` : modelName}</td>
            <td class="creator">${creatorUrl ? `<a href="${escapeAttr(creatorUrl)}" target="_blank" rel="noopener noreferrer">${creatorName}</a>` : creatorName}</td>
            <td class="mono">${escapeHtml(model.params || "-")}</td>
            <td class="mono${contextClass}">${escapeHtml(model.context || "-")}</td>
            ${scoreCells}
          </tr>
        `;
      }

      function updateMeta() {
        const shown = state.filteredModels.length;
        const total = state.data.models.length;
        ui.resultCount.textContent = `${shown} of ${total} models`;
        ui.benchmarkCount.textContent = `${state.benchmarkKeys.length} benchmarks`;
      }

      function getTopScoresByBenchmark(models) {
        const topScores = {};
        state.benchmarkKeys.forEach((key) => {
          const values = models
            .map((model) => toNumber(model.scores?.[key]))
            .filter((value) => Number.isFinite(value));
          topScores[key] = values.length ? Math.max(...values) : Number.NaN;
        });
        return topScores;
      }

      function getOrderedBenchmarkKeys(benchmarks) {
        const keys = Object.keys(benchmarks || {});
        const prioritized = PRIORITY_BENCHMARK_KEYS.filter((key) => keys.includes(key));
        const remaining = keys.filter((key) => !PRIORITY_BENCHMARK_KEYS.includes(key));
        return [...prioritized, ...remaining];
      }

      function getBenchmarkLabel(key) {
        return BENCHMARK_LABEL_OVERRIDES[key] || state.data?.benchmarks?.[key]?.name || key;
      }

      function getBestInTableByModel(models) {
        const result = new Map();
        models.forEach((model) => result.set(model, new Set()));

        if (!models.length) {
          return result;
        }

        const topByBenchmark = getTopScoresByBenchmark(models);
        const topContext = Math.max(...models.map((m) => parseUnitNumber(m.context)).filter((v) => Number.isFinite(v)));

        models.forEach((model) => {
          const flags = result.get(model);
          if (!flags) {
            return;
          }

          const contextValue = parseUnitNumber(model.context);
          if (Number.isFinite(contextValue) && Number.isFinite(topContext) && nearlyEqual(contextValue, topContext)) {
            flags.add("context");
          }

          state.benchmarkKeys.forEach((key) => {
            const value = toNumber(model.scores?.[key]);
            const top = topByBenchmark[key];
            if (Number.isFinite(value) && Number.isFinite(top) && nearlyEqual(value, top)) {
              flags.add(key);
            }
          });
        });

        return result;
      }

      function formatScore(value) {
        if (!Number.isFinite(value)) {
          return '<span class="num na">-</span>';
        }
        return value.toFixed(1);
      }

      function toNumber(value) {
        if (typeof value === "number" && Number.isFinite(value)) {
          return value;
        }
        if (typeof value === "string") {
          const parsed = Number(value);
          return Number.isFinite(parsed) ? parsed : Number.NaN;
        }
        return Number.NaN;
      }

      function parseUnitNumber(raw) {
        if (raw == null) {
          return Number.NaN;
        }

        const text = String(raw).trim().toLowerCase();
        const match = text.match(/([0-9]*\.?[0-9]+)\s*([a-z]+)/);
        if (!match) {
          const plain = Number(text.replace(/,/g, ""));
          return Number.isFinite(plain) ? plain : Number.NaN;
        }

        const value = Number(match[1]);
        const unit = match[2];
        if (!Number.isFinite(value)) {
          return Number.NaN;
        }

        const multipliers = {
          k: 1e3,
          m: 1e6,
          b: 1e9,
          t: 1e12
        };

        const tail = unit[0];
        if (tail in multipliers) {
          return value * multipliers[tail];
        }

        return value;
      }

      function nearlyEqual(a, b) {
        return Math.abs(a - b) < 1e-9;
      }

      function sortModeValue(key, direction) {
        return `${key}::${direction}`;
      }

      function parseSortModeValue(value) {
        const parts = String(value).split("::");
        const key = parts[0] || "aa_intelligence_index";
        const direction = parts[1] === "asc" ? "asc" : "desc";
        return { key, direction };
      }

      function escapeHtml(value) {
        return String(value)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/\"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      function escapeAttr(value) {
        return escapeHtml(value);
      }

      function debounce(fn, delayMs) {
        let timer;
        return function (...args) {
          clearTimeout(timer);
          timer = setTimeout(() => fn.apply(this, args), delayMs);
        };
      }
    })();
  </script>
</body>
</html>
